<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="/socket.io/socket.io.js"></script>
    
    <style>

        table,
        th,
        td {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    index file


        <form id="form">
            <input type="text" name="message" id="message">
            <input type="text" name="room" id="room" value="1">

            <button type="submit">Send Messae</button>
        </form>

        

        <form id="form_email">
                <input type="text" name="email" id="email">
    
                <button type="submit">Login with email</button>
            </form>



    <script>
        let SOCKET = null;

        const handleSOCKET = (SOCKET) => {
            

            SOCKET.on('error', message => console.log('Error', message))
    
            SOCKET.on('connect', socket => {
                console.log('connected?', SOCKET.connected)
    
                // sendMessage('hey, it\'s client');
    
                
    
            })

            SOCKET.on('sendMessageToClients', data => {
                console.log('new message', data);
                // messages.unshift(data);
                // console.clear();

                // console.table(messages, ['message', 'user'])

                // console.table(messages, )
            })
        }

            const handleEmailForm = e => {
                e.preventDefault();

                const email = e.target.email.value;
                if (!email) return alert('no email selected');

                fetch('http://localhost:3000/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email,
                        password: 'password1234'
                    })
                })
                .then(response => {
                    console.log('fetch response', response.status)
                    const token = response.headers.get('authorization');
                    // console.log('token', token);
    
                    globalToken = token;

                    SOCKET = io.connect('/', {
                        secure: false,
                        transports: ['websocket'],
                        query: { token }
                    });

                    handleSOCKET(SOCKET);

                    
                });
            }

            const form = document.querySelector('#form');

            const sendMessage = (message, room) => {
                return new Promise((resolve, reject) => {
                    SOCKET.emit('message', { message, room }, response => {
                        resolve({ message, response });
                    });
                })
            };

            const handleForm = e => {
                e.preventDefault();

                // console.log('send message')

                const message = e.target.message.value;
                if (!message) return;

                const room = e.target.room.value;
                if (!message) return;

                sendMessage(message, room)
                .then(response => {
                    if (response.response.success) {
                        console.log('message sent');
                    } else {
                        console.log('message failed: ', response.response.message)
                    }
                    
                });
            }

            form.addEventListener('submit', handleForm)

            const formEmail = document.querySelector('#form_email');

            formEmail.addEventListener('submit', handleEmailForm)


            const messages = []
        
            


            
    
        </script>

</body>
</html>